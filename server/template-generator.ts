import * as XLSX from 'xlsx';
import { join } from 'path';

export interface TemplateVariant {
  name: string;
  filename: string;
  description: string;
  data: any[][];
}

// Вариант 1: Классический недельный формат (по дням недели)
export function createWeeklyTemplate(): TemplateVariant {
  const days = ['Понедельник', 'Вторник', 'Среда', 'Четверг', 'Пятница', 'Суббота'];
  const timeSlots = [
    '08:30-10:00', '10:15-11:45', '12:00-13:30', 
    '13:45-15:15', '15:30-17:00', '17:15-18:45'
  ];

  const data = [
    ['РАСПИСАНИЕ ЗАНЯТИЙ ТАВРИЧЕСКОГО КОЛЛЕДЖА', '', '', '', '', '', ''],
    ['', '', '', '', '', '', ''],
    ['Время', ...days],
    ...timeSlots.map(time => [
      time,
      'Предмет / Преподаватель / Группа / Аудитория / Тип',
      'Предмет / Преподаватель / Группа / Аудитория / Тип', 
      'Предмет / Преподаватель / Группа / Аудитория / Тип',
      'Предмет / Преподаватель / Группа / Аудитория / Тип',
      'Предмет / Преподаватель / Группа / Аудитория / Тип',
      'Предмет / Преподаватель / Группа / Аудитория / Тип'
    ]),
    ['', '', '', '', '', '', ''],
    ['ПРИМЕР ЗАПОЛНЕНИЯ:'],
    ['08:30-10:00', 'Математика / Иванов И.И. / ИТ-21 / 101 / Лекция', '', '', '', '', ''],
    ['', 'Программирование / Петров П.П. / ИТ-22 / Лаб-1 / Практика', '', '', '', '', '']
  ];

  return {
    name: 'Недельная сетка',
    filename: 'template_weekly_grid.xlsx',
    description: 'Классический формат расписания в виде недельной сетки. Удобен для общего обзора.',
    data
  };
}

// Вариант 2: Список занятий (простая таблица)
export function createSimpleListTemplate(): TemplateVariant {
  const data = [
    ['РАСПИСАНИЕ ЗАНЯТИЙ - СПИСОК'],
    [''],
    ['День недели', 'Время начала', 'Время окончания', 'Предмет', 'Преподаватель', 'Группа', 'Аудитория', 'Тип занятия'],
    ['Понедельник', '08:30', '10:00', 'Математика', 'Иванов Иван Иванович', 'ИТ-21', '101', 'Лекция'],
    ['Понедельник', '10:15', '11:45', 'Программирование', 'Петров Петр Петрович', 'ИТ-21', 'Лаб-1', 'Практика'],
    ['Вторник', '08:30', '10:00', 'Базы данных', 'Сидоров Сидор Сидорович', 'ИТ-22', '102', 'Лекция'],
    [''],
    ['ИНСТРУКЦИЯ ПО ЗАПОЛНЕНИЮ:'],
    ['1. День недели: Понедельник, Вторник, Среда, Четверг, Пятница, Суббота'],
    ['2. Время: в формате ЧЧ:ММ (например: 08:30)'],
    ['3. Тип занятия: Лекция, Практика, Семинар, Лабораторная'],
    ['4. Заполняйте каждое занятие в отдельной строке'],
    [''],
    ['ПУСТЫЕ СТРОКИ ДЛЯ ЗАПОЛНЕНИЯ:'],
    ['', '', '', '', '', '', '', ''],
    ['', '', '', '', '', '', '', ''],
    ['', '', '', '', '', '', '', ''],
    ['', '', '', '', '', '', '', ''],
    ['', '', '', '', '', '', '', '']
  ];

  return {
    name: 'Простой список',
    filename: 'template_simple_list.xlsx',
    description: 'Простая таблица со всеми занятиями подряд. Легко заполнять и импортировать.',
    data
  };
}

// Вариант 3: По группам (отдельные листы/секции для каждой группы)
export function createGroupBasedTemplate(): TemplateVariant {
  const data = [
    ['РАСПИСАНИЕ ПО ГРУППАМ'],
    [''],
    ['ГРУППА: ИТ-21'],
    ['День', 'Время', 'Предмет', 'Преподаватель', 'Аудитория', 'Тип'],
    ['Понедельник', '08:30-10:00', 'Математика', 'Иванов И.И.', '101', 'Лекция'],
    ['Понедельник', '10:15-11:45', 'Программирование', 'Петров П.П.', 'Лаб-1', 'Практика'],
    ['Вторник', '08:30-10:00', 'Английский язык', 'Смирнова А.А.', '201', 'Семинар'],
    ['', '', '', '', '', ''],
    ['', '', '', '', '', ''],
    [''],
    ['ГРУППА: ИТ-22'],
    ['День', 'Время', 'Предмет', 'Преподаватель', 'Аудитория', 'Тип'],
    ['Понедельник', '08:30-10:00', 'Базы данных', 'Сидоров С.С.', '102', 'Лекция'],
    ['Понедельник', '10:15-11:45', 'Веб-разработка', 'Козлов К.К.', 'Лаб-2', 'Практика'],
    ['', '', '', '', '', ''],
    ['', '', '', '', '', ''],
    [''],
    ['ГРУППА: ЭК-21'],
    ['День', 'Время', 'Предмет', 'Преподаватель', 'Аудитория', 'Тип'],
    ['Понедельник', '08:30-10:00', 'Экономика', 'Волков В.В.', '301', 'Лекция'],
    ['', '', '', '', '', ''],
    ['', '', '', '', '', ''],
    [''],
    ['ДОБАВЬТЕ НОВЫЕ ГРУППЫ ПО ОБРАЗЦУ ВЫШЕ']
  ];

  return {
    name: 'По группам',
    filename: 'template_by_groups.xlsx',
    description: 'Расписание организовано по группам. Удобно для заполнения по одной группе за раз.',
    data
  };
}

// Вариант 4: Матричный формат (преподаватель x время)
export function createTeacherTimeMatrix(): TemplateVariant {
  const timeSlots = [
    '08:30-10:00', '10:15-11:45', '12:00-13:30', 
    '13:45-15:15', '15:30-17:00'
  ];

  const data = [
    ['РАСПИСАНИЕ ПРЕПОДАВАТЕЛЕЙ'],
    [''],
    ['', 'Понедельник', 'Вторник', 'Среда', 'Четверг', 'Пятница', 'Суббота'],
    ['ИВАНОВ И.И. (Математика)'],
    ...timeSlots.map(time => [
      time,
      'Предмет/Группа/Аудитория/Тип',
      'Предмет/Группа/Аудитория/Тип',
      'Предмет/Группа/Аудитория/Тип',
      'Предмет/Группа/Аудитория/Тип',
      'Предмет/Группа/Аудитория/Тип',
      'Предмет/Группа/Аудитория/Тип'
    ]),
    [''],
    ['ПЕТРОВ П.П. (Программирование)'],
    ...timeSlots.map(time => [
      time,
      'Предмет/Группа/Аудитория/Тип',
      'Предмет/Группа/Аудитория/Тип', 
      'Предмет/Группа/Аудитория/Тип',
      'Предмет/Группа/Аудитория/Тип',
      'Предмет/Группа/Аудитория/Тип',
      'Предмет/Группа/Аудитория/Тип'
    ]),
    [''],
    ['ПРИМЕР ЗАПОЛНЕНИЯ:'],
    ['08:30-10:00', 'Математика/ИТ-21/101/Лекция', '', '', '', '', ''],
    [''],
    ['ДОБАВЬТЕ ДРУГИХ ПРЕПОДАВАТЕЛЕЙ ПО ОБРАЗЦУ']
  ];

  return {
    name: 'По преподавателям',
    filename: 'template_by_teachers.xlsx',
    description: 'Расписание организовано по преподавателям. Удобно видеть нагрузку каждого преподавателя.',
    data
  };
}

export function generateAllTemplates(): TemplateVariant[] {
  return [
    createWeeklyTemplate(),
    createSimpleListTemplate(),
    createGroupBasedTemplate(),
    createTeacherTimeMatrix()
  ];
}

export function saveTemplateToFile(template: TemplateVariant, outputDir: string = './templates'): string {
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(template.data);

  // Стилизация
  ws['!cols'] = [
    { width: 15 }, { width: 25 }, { width: 25 }, { width: 25 },
    { width: 25 }, { width: 15 }, { width: 15 }, { width: 15 }
  ];

  XLSX.utils.book_append_sheet(wb, ws, 'Расписание');

  const filePath = join(outputDir, template.filename);
  XLSX.writeFile(wb, filePath);
  
  return filePath;
}